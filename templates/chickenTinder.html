<!DOCTYPE html>
<html lang = "en">
<head>
  <meta charset = "UTF-8">
  <title>Chicken Tinder</title>
  <style>
    .hidden{
      display: none;
    }
  </style>
</head>
<body>
  <h1>Chicken Tinder</h1>
  <!--setup-->
  <div id = "setup">
    <h3>Start Voting</h3>
    <!--since events is not yet setup testing w/ inputs (REMOVE LATER)-->
    <label>Username:</label>
    <input type = "text" id = "username" value = "testuser"><br><br>

    <label>Event Id:</label>
    <input type = "number" id = "eventId" value = "1"><br><br>

    <!--start button!!!-->
    <button onclick = "startVoting()">Start</button>
  </div>

  <!--Voting sectuion-->
  <div id = "votingSection" class = "hidden">
    <h2 id = "restaurantName"></h2>
    <!--Votes! yes and no assign to 1 and 0-->
    <button onclick = "vote(0)">No</button>
    <button onclick = "vote(1)">Yes</button>
  </div>

  <!--Display results-->
  <div id = "resultsSection" class = "hidden">
    <h2>Voting Completed</h2>
    <div id = "resultsList"></div>
  </div>

  <!--JS script for functionality!!-->
  <script>
    //store global vars (these r for testing!!!!)
    let currentUsername = '';
    let currentEventId = 1;
    let currentRestaurant = null;

    //start the voting by setting up stuff
    function startVoting(){
      //grab info from input
      currentUsername = document.getElementById('username').value;
      //grab info but parse it to make it actually an int
      currentEventId = parseInt(document.getElementById('eventId').value);
      
      //hide the setup and show voting
      document.getElementById('setup').classList.add('hidden');
      document.getElementById('votingSection').classList.remove('hidden');

      loadNextRestaurant();
    }

    //load the next rest to be voted on 
    function loadNextRestaurant(){
      //call api w/ params
      fetch(`/api/chickenTinder/nextRest?username=${currentUsername}&eventId=${currentEventId}`)

      //convert to JSON & process
        .then(response => response.json())
        .then(data => {
          if(data.done){
            showResults(data.results);    //if all have been voted on show results
          } 
          else{   //if not show restaurant
            currentRestaurant = data.restaurant;
            displayRestaurant(data.restaurant);
          }
        })
    }

    //display rest names
    function displayRestaurant(restaurant){
      //textContext sets elements text!! 
      document.getElementById('restaurantName').textContent = restaurant.name;
    }

    //submit the vote!
    function vote(voteVal){
      fetch('/api/chickenTinder/vote', { method: 'POST', 
        //have to tell api json being sent
        headers: {'Content-Type': 'application/json'},
        //turn vote into package
        body: JSON.stringify({
          username: currentUsername,
          eventId: currentEventId,
          restaurantId: currentRestaurant.id,
          vote: voteVal
        })

      })
      //convert to json and process
      .then(response => response.json())
      .then(data => {
        if(data.success){
            loadNextRestaurant(); 
        } 
      })
    }

    //show final results
    function showResults(results){
      //hide voting and show results
      document.getElementById('votingSection').classList.add('hidden');
      document.getElementById('resultsSection').classList.remove('hidden');

      //get results
      const resultsList = document.getElementById('resultsList');
      results.forEach((restaurant, index) => {
        const div = document.createElement('div');
        div.innerHTML = `${index + 1}. ${restaurant.name} - ${restaurant.votes} votes`;
        resultsList.appendChild(div);
      });
    }
  </script>
</body>
</html>